const ENFORMATION_RESOURCES = {
    "oce.ovid.com": {
        name: "APAPsychArticles",
        url: "https://06101bc56-y-https-ovidsp-dc1-ovid-com.z.e-nformation.ro",
    },
    "pubs.acs.org": {
        name: "ACS_AnelisPlus",
        url: "https://0610wbc33-y-https-pubs-acs-org.z.e-nformation.ro",
    },
    "pubs.aip.org": {
        name: "AIP_AnelisPlus",
        url: "https://z.e-nformation.ro/MuseSessionID=06107bc36/MuseProtocol=https/MuseHost=pubs.aip.org/MusePath",
    },
    "journals.aps.org": {
        name: "APS_Vest",
        url: "https://06108bc37-y-https-journals-aps-org.z.e-nformation.ro",
    },
    "www.cabidigitallibrary.org": {
        name: "CabiDL_AnelisPlus",
        url: "https://0610hbc38-y-https-www-cabidigitallibrary-org.z.e-nformation.ro",
    },
    "www.ceeol.com": {
        name: "CEEOL_journals",
        url: "https://0610abc3a-y-https-www-ceeol-com.z.e-nformation.ro",
    },
    // "www.sciencedirect.com": {
    //     name: "ScienceDirectEbooks_AnelisPlus",
    //     url: "https://0610dbc3e-y-https-www-sciencedirect-com.z.e-nformation.ro",
    // },
    "www.sciencedirect.com": {
        name: "ScienceDirect_AnelisPlus",
        url: "https://0610dbc3e-y-https-www-sciencedirect-com.z.e-nformation.ro",
    },
    "www.emerald.com": {
        name: "EmeraldJournals_AnelisPlus",
        url: "https://0610qbc3t-y-https-www-emerald-com.z.e-nformation.ro",
    },
    // "www.emerald.com": {
    //     name: "EmeraldEbooks_AnelisPlus",
    //     url: "https://06104bc3u-y-https-www-emerald-com.z.e-nformation.ro",
    // },
    // "ieeexplore.ieee.org": {
    //     name: "IEEEeBooksNOW_AnelisPlus",
    //     url: "https://06105bc3v-y-https-ieeexplore-ieee-org.z.e-nformation.ro",
    // },
    "ieeexplore.ieee.org": {
        name: "IEEE_IEL_AnelisPlus",
        url: "https://06106bc3w-y-https-ieeexplore-ieee-org.z.e-nformation.ro",
    },
    "digital-library.theiet.org": {
        name: "IETDL_AnelisPlus",
        url: "https://0610ibc3x-y-https-digital--library-theiet-org.z.e-nformation.ro",
    },
    "incites.clarivate.com": {
        name: "InCites_UVT",
        url: "https://0610tbc45-y-https-access-clarivate-com.z.e-nformation.ro",
    },
    "iopscience.iop.org": {
        name: "IOPJournals_AnelisPlus",
        url: "https://06109bc46-y-https-iopscience-iop-org.z.e-nformation.ro",
    },
    "mathscinet.ams.org": {
        name: "MathSciNet_AnelisPlus",
        url: "https://0610jbc48-y-https-mathscinet-ams-org.z.e-nformation.ro",
    },
    "www.nature.com": {
        name: "Nature_AnelisPlus",
        url: "https://0610ubc49-y-https-www-nature-com.z.e-nformation.ro",
    },
    // "www.proquest.com": {
    //     name: "PQCentral_AnelisPlus",
    //     url: "https://www.proquest.com/?parentSessionId=gpCTgcrjsklEh5zqyRDVLf%2BbrIONyUu%2F6hb1mii9WBk%3D&accountid=196263",
    // },
    "www.proquest.com": {
        name: "PQDT_UVT",
        url: "https://0610vbc4c-y-https-www-proquest-com.z.e-nformation.ro",
    },
    "journals.sagepub.com": {
        name: "SageJournals_AnelisPlus",
        url: "https://0610pbc4f-y-https-journals-sagepub-com.z.e-nformation.ro",
    },
    "sk.sagepub.com": {
        name: "SAGEKnowledgeEbooks_AnelisPlus",
        url: "https://06102bc4h-y-https-sk-sagepub-com.z.e-nformation.ro",
    },
    "www.scopus.com": {
        name: "Scopus_AnelisPlus",
        url: "https://0610ebc4l-y-https-www-scopus-com.z.e-nformation.ro",
    },
    "link.springer.com": {
        name: "SpringerLink_AnelisPlus",
        url: "https://0610lbc4m-y-https-link-springer-com.z.e-nformation.ro",
    },
    "www.tandfonline.com": {
        name: "TandFJournals_UVT",
        url: "https://0610obc4n-y-https-www-tandfonline-com.z.e-nformation.ro",
    },
    "access.clarivate.com": {
        name: "ClarivateWoS_AnelisPlus",
        url: "https://0610mbc4o-y-https-www-webofscience-com.z.e-nformation.ro",
    },
    // "onlinelibrary.wiley.com": {
    //     name: "WileyBooks_AnelisPlus",
    //     url: "https://0610gbc4r-y-https-onlinelibrary-wiley-com.z.e-nformation.ro",
    // },
    "onlinelibrary.wiley.com": {
        name: "WileyJournals_AnelisPlus",
        url: "https://0610fbc4s-y-https-onlinelibrary-wiley-com.z.e-nformation.ro",
    },
    "www.degruyter.com": {
        name: "DeGruytereBooks_AnelisPlus",
        url: "https://06103bc4t-y-https-www-degruyter-com.z.e-nformation.ro",
    },
    "www.igpublish.com": {
        name: "iGLibraryALA_AnelisPlus",
        url: "https://0610nbc4u-y-https-portal-igpublish-com.z.e-nformation.ro/iglibrary",
    },
    "portal.igpublish.com": {
        name: "iGLibraryALA_AnelisPlus",
        url: "https://0610nbc4u-y-https-portal-igpublish-com.z.e-nformation.ro/iglibrary",
    },
};

function transformUrl(url, callback) {
    const link_url = new URL(url);
    if (link_url.hostname in ENFORMATION_RESOURCES) {
        // get resource
        var resource = ENFORMATION_RESOURCES[link_url.hostname];
        if (
            link_url.hostname === "access.clarivate.com" &&
            link_url.searchParams.get("app") === "incites"
        ) {
            resource = ENFORMATION_RESOURCES["incites.clarivate.com"];
        }
        console.log(resource);

        // get redirect url
        var redirect_url = new URL(resource_url);
        if (resource.name === "AIP_AnelisPlus") {
            redirect_url.pathname = `${redirect_url.pathname}${link_url.pathname}`;
        } else if (resource.name === "Scopus_AnelisPlus") {
            // nothing to do
        } else {
            redirect_url.pathname = link_url.pathname;
            redirect_url.search = link_url.search;
        }
        console.log(redirect_url);

        // callback
        callback(redirect_url.href);
    }
}

browser.action.onClicked.addListener((tab) => {
    transformUrl(tab.url, (newUrl) => {
        browser.tabs.update(tab.id, { url: newUrl });
    });
});

browser.contextMenus.onClicked.addListener((info, tab) => {
    transformUrl(info.linkUrl, (newUrl) => {
        browser.tabs.create({ url: newUrl });
    });
});

browser.runtime.onInstalled.addListener((details) => {
    browser.storage.sync.get({ university_id: null }, (items) => {
        browser.contextMenus.create({
            title: "Open link through e-nformation",
            contexts: ["link"],
            id: "redirect",
        });
    });
});
